#!/usr/bin/env node
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const logFile = path_1.default.join(process.cwd(), "xavren-install.log");
const log = (msg) => {
    const timestamp = new Date().toISOString();
    const logMsg = `[${timestamp}] ${msg}\n`;
    try {
        fs_1.default.appendFileSync(logFile, logMsg);
    }
    catch (e) {
        // Ignore log file errors
    }
    console.error(msg);
};
function findProjectRoot(startDir) {
    let currentDir = startDir;
    const root = path_1.default.parse(currentDir).root;
    // Traverse up until we find node_modules in the path
    while (currentDir !== root) {
        if (currentDir.includes('node_modules')) {
            // Go up to parent of node_modules
            const parts = currentDir.split(path_1.default.sep);
            const nodeModulesIndex = parts.lastIndexOf('node_modules');
            if (nodeModulesIndex !== -1) {
                // Join everything before node_modules
                return parts.slice(0, nodeModulesIndex).join(path_1.default.sep);
            }
        }
        currentDir = path_1.default.dirname(currentDir);
    }
    return null;
}
function installPrePushHook() {
    log("=== Xavren Hook Installation ===");
    log(`üìç Script running from: ${process.cwd()}`);
    log(`üë§ User: ${process.env.USER || process.env.USERNAME}`);
    log(`üîß Node version: ${process.version}`);
    // Find the project root (parent of node_modules)
    const projectRoot = findProjectRoot(process.cwd());
    if (!projectRoot) {
        log("‚ùå Could not find project root (parent of node_modules).");
        return;
    }
    log(`‚úÖ Found project root at: ${projectRoot}`);
    const gitDir = path_1.default.join(projectRoot, ".git");
    log(`üîç Looking for .git at: ${gitDir}`);
    log(`üìÅ .git exists: ${fs_1.default.existsSync(gitDir)}`);
    if (!fs_1.default.existsSync(gitDir)) {
        log("‚ùå Not a Git repository. Skipping hook installation.");
        log("üí° This is normal if installing in a non-git project.");
        return;
    }
    const hookDir = path_1.default.join(gitDir, "hooks");
    const hookPath = path_1.default.join(hookDir, "pre-push");
    log(`üìÇ Hook directory: ${hookDir}`);
    log(`üìÑ Hook path: ${hookPath}`);
    // Check permissions
    try {
        fs_1.default.accessSync(gitDir, fs_1.default.constants.W_OK);
        log("‚úÖ Write permission confirmed");
    }
    catch (err) {
        log(`‚ùå Permission error: ${err.message}`);
        log("Try running: sudo chown -R $USER .git");
        return;
    }
    // Create hooks directory
    if (!fs_1.default.existsSync(hookDir)) {
        try {
            fs_1.default.mkdirSync(hookDir, { recursive: true });
            log("üìÅ Created hooks directory");
        }
        catch (err) {
            log(`‚ùå Failed to create hooks dir: ${err.message}`);
            return;
        }
    }
    // Remove old hook
    if (fs_1.default.existsSync(hookPath)) {
        try {
            fs_1.default.unlinkSync(hookPath);
            log("‚ôªÔ∏è  Removed existing pre-push hook");
        }
        catch (unlinkErr) {
            log(`‚ö†Ô∏è  Couldn't remove old hook: ${unlinkErr.message}`);
        }
    }
    const hookContent = `#!/bin/bash
# Auto-generated by xavren installer
echo "üöÄ Running xavcli postinstall before git push..."
xavcli_postinstall || echo "‚ö†Ô∏è xavcli_postinstall failed, but continuing push..."
`;
    try {
        fs_1.default.writeFileSync(hookPath, hookContent, { encoding: "utf-8", mode: 0o755 });
        log("üìù Hook file written");
        if (fs_1.default.existsSync(hookPath)) {
            const stats = fs_1.default.statSync(hookPath);
            const isExecutable = (stats.mode & 0o111) !== 0;
            log(`‚úÖ Pre-push hook installed successfully!`);
            log(`üîê Executable: ${isExecutable}`);
            log(`üìä File size: ${stats.size} bytes`);
            log(`üìç Hook location: ${hookPath}`);
        }
        else {
            log("‚ùå Hook file was not created!");
        }
    }
    catch (err) {
        log(`‚ùå Write error: ${err.message}`);
        log(err.stack);
    }
    log("=== Installation Complete ===");
}
try {
    installPrePushHook();
}
catch (err) {
    log(`‚ùå Fatal error: ${err.message}`);
    log(err.stack);
}
// #!/usr/bin/env node
// import fs from "fs";
// import path from "path";
// function installPrePushHook() {
//   console.log("ü™ù Setting up xavren pre-push hook...");
//   const gitDir = path.resolve(process.cwd(), ".git");
//   const hookDir = path.join(gitDir, "hooks");
//   const hookPath = path.join(hookDir, "pre-push");
//   // 1Ô∏è‚É£ Check if we're in a Git repo
//   if (!fs.existsSync(gitDir)) {
//     console.log("‚ùå Not a Git repository. Skipping hook installation.");
//     return;
//   }
//   fs.mkdirSync(hookDir, { recursive: true });
//   // 2Ô∏è‚É£ Hook content ‚Äî run xavcli_postinstall but never stop push
//   const hookContent = `#!/bin/bash
// # Auto-generated by xavren installer
// # This hook runs xavcli postinstall logic before pushing, but never aborts the push
// echo "üöÄ Running xavcli postinstall before git push..."
// # Run postinstall CLI
// xavcli_postinstall || echo "‚ö†Ô∏è xavcli_postinstall failed, but continuing push..."
// `;
//   // 3Ô∏è‚É£ Write or overwrite the hook file
//   fs.writeFileSync(hookPath, hookContent, "utf-8");
//   fs.chmodSync(hookPath, 0o755);
//   console.log("‚úÖ Pre-push hook installed successfully!");
// }
// try {
//   installPrePushHook();
// } catch (err) {
//   console.error("‚ùå Failed to install pre-push hook:", err);
// }
//# sourceMappingURL=prepush_Setup.js.map